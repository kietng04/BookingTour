<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E2E Test - MoMo Payment</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen py-8">
        <div class="max-w-4xl mx-auto px-4">
            <h1 class="text-3xl font-bold text-gray-900 mb-8">
                E2E Test - Real MoMo Payment
            </h1>
            
            <!-- Step 1: Login -->
            <div id="step1" class="bg-white rounded-lg shadow p-6 mb-4">
                <h2 class="text-xl font-semibold mb-4">Step 1: Login (Mock)</h2>
                <button
                    onclick="login()"
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
                >
                    Login as User ID 1
                </button>
            </div>

            <!-- Step 2: Select Tour -->
            <div id="step2" class="bg-white rounded-lg shadow p-6 mb-4 hidden">
                <h2 class="text-xl font-semibold mb-4">Step 2: Select Tour</h2>
                <div id="toursList"></div>
            </div>

            <!-- Step 3: Create Booking -->
            <div id="step3" class="bg-white rounded-lg shadow p-6 mb-4 hidden">
                <h2 class="text-xl font-semibold mb-4">Step 3: Create Booking</h2>
                <div id="tourDetails"></div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Number of Guests</label>
                    <input
                        type="number"
                        id="numGuests"
                        min="1"
                        max="10"
                        value="1"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md"
                    />
                </div>
                <button
                    onclick="createBooking()"
                    class="w-full mt-4 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700"
                >
                    Create Booking
                </button>
            </div>

            <!-- Step 4: MoMo Payment -->
            <div id="step4" class="bg-white rounded-lg shadow p-6 mb-4 hidden">
                <h2 class="text-xl font-semibold mb-4">Step 4: MoMo Payment</h2>
                <div id="bookingDetails"></div>
                <button
                    onclick="initiateMoMoPayment()"
                    class="w-full mt-4 bg-pink-600 text-white py-3 px-4 rounded-md hover:bg-pink-700 text-lg font-semibold"
                >
                    ðŸ’³ Pay with MoMo
                </button>
            </div>

            <!-- Step 5: QR Code -->
            <div id="step5" class="bg-white rounded-lg shadow p-6 hidden">
                <h2 class="text-xl font-semibold mb-4">Step 5: Scan QR Code</h2>
                <div class="text-center">
                    <div class="bg-gray-100 p-8 rounded-lg inline-block mb-4">
                        <img id="qrCode" src="" alt="MoMo QR Code" class="mx-auto" />
                    </div>
                    <div id="paymentInfo"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let currentUser = { id: 1, name: 'Test User' };
        let selectedTour = null;
        let currentBooking = null;

        async function login() {
            console.log('Login as User ID 1');
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            await loadTours();
        }

        async function loadTours() {
            try {
                const response = await fetch(`${API_BASE}/tours`);
                const tours = await response.json();
                
                const toursList = document.getElementById('toursList');
                toursList.innerHTML = tours.map(tour => `
                    <div class="border p-4 rounded-lg mb-2 cursor-pointer hover:bg-gray-50" onclick="selectTour(${tour.id})">
                        <h3 class="font-semibold">${tour.title}</h3>
                        <p class="text-sm text-gray-600">${tour.price.toLocaleString()} VND</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading tours:', error);
                alert('Error loading tours: ' + error.message);
            }
        }

        async function selectTour(tourId) {
            try {
                const response = await fetch(`${API_BASE}/tours/${tourId}`);
                selectedTour = await response.json();
                
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.remove('hidden');
                
                document.getElementById('tourDetails').innerHTML = `
                    <p class="text-gray-600 mb-2"><strong>Tour:</strong> ${selectedTour.title}</p>
                    <p class="text-gray-600 mb-2"><strong>Price:</strong> ${selectedTour.price.toLocaleString()} VND</p>
                `;
            } catch (error) {
                console.error('Error loading tour:', error);
                alert('Error loading tour: ' + error.message);
            }
        }

        async function createBooking() {
            try {
                const numGuests = parseInt(document.getElementById('numGuests').value);
                const totalAmount = selectedTour.price * numGuests;
                
                const departuresResponse = await fetch(`${API_BASE}/tours/${selectedTour.id}/departures`);
                const departures = await departuresResponse.json();
                const departureId = departures[0]?.id || 1;
                
                const bookingData = {
                    userId: currentUser.id,
                    tourId: selectedTour.id,
                    departureId: departureId,
                    seats: numGuests,
                    totalAmount: totalAmount,
                    paymentOverride: 'momo'
                };
                
                const response = await fetch(`${API_BASE}/bookings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData)
                });
                
                currentBooking = await response.json();
                console.log('Booking created:', currentBooking);
                
                document.getElementById('step3').classList.add('hidden');
                document.getElementById('step4').classList.remove('hidden');
                
                document.getElementById('bookingDetails').innerHTML = `
                    <p class="text-gray-600 mb-2"><strong>Booking ID:</strong> ${currentBooking.id}</p>
                    <p class="text-gray-600 mb-2"><strong>Tour:</strong> ${selectedTour.title}</p>
                    <p class="text-gray-600 mb-2"><strong>Guests:</strong> ${numGuests}</p>
                    <p class="text-gray-600 mb-4"><strong>Total:</strong> ${totalAmount.toLocaleString()} VND</p>
                `;
            } catch (error) {
                console.error('Error creating booking:', error);
                alert('Error creating booking: ' + error.message);
            }
        }

        async function initiateMoMoPayment() {
            try {
                const momoRequest = {
                    bookingId: currentBooking.id.toString(),
                    amount: currentBooking.totalAmount,
                    userId: currentUser.id,
                    orderInfo: `Booking ${currentBooking.id} - ${selectedTour.title}`,
                    extraData: ''
                };
                
                const response = await fetch(`${API_BASE}/payments/momo/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(momoRequest)
                });
                
                const momoResponse = await response.json();
                console.log('MoMo response:', momoResponse);
                
                document.getElementById('step4').classList.add('hidden');
                document.getElementById('step5').classList.remove('hidden');
                
                document.getElementById('qrCode').src = momoResponse.qrCodeUrl || 
                    `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${momoResponse.deeplink}`;
                
                document.getElementById('paymentInfo').innerHTML = `
                    <p class="text-sm text-gray-600 mb-2"><strong>Order ID:</strong> ${momoResponse.orderId}</p>
                    <p class="text-sm text-gray-600 mb-2"><strong>Amount:</strong> ${currentBooking.totalAmount.toLocaleString()} VND</p>
                    <p class="text-sm text-gray-600 mb-4"><strong>Status:</strong> Waiting for payment...</p>
                    <a href="${momoResponse.payUrl}" target="_blank" class="text-blue-600 hover:underline">
                        Open MoMo Payment Page
                    </a>
                `;
            } catch (error) {
                console.error('Error initiating MoMo payment:', error);
                alert('Error initiating MoMo payment: ' + error.message);
            }
        }
    </script>
</body>
</html>
